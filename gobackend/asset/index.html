<!doctype html>
<html>
  <head>
    <title>Webassembly</title>
  </head>
  <style>
    .table {
      width: 30%;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
    }
  </style>
  <body>
    <h1>Webassembly</h1>
    <div class='table'>
      <div>&nbsp;</div>
      <div><button id='up'>UP</button></div>
      <div>&nbsp;</div>
      <div><button id='left'>LEFT</button></div>
      <div>&nbsp;</div>
      <div><button id='right'>RIGHT</button></div>
      <div>&nbsp;</div>
      <div><button id='down'>DOWN</button></div>
      <div>&nbsp;</div>
    </div>
    
    <pre id='map'></pre>
    <canvas id='main'></canvas>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      let id = Math.floor(Math.random() * 10);
      let socket = io({ auth: { token: id } });
      let tileMap = {};
      let users = {};
      let nonce = -1;
      let tilesetImage = new Image();
      const tileSize = 32;
      const imageNumTiles = 16;

      const render = (tileMap, users) => {
        m = JSON.parse(JSON.stringify(tileMap.array)).map(row => row.map(col => col.id));
        Object.entries(users).forEach(([k, v]) => {
          m[v.y][v.x] = k;
        });
        let s = '';
        m.forEach(row => {
          s += row.join(' ') + '\n';
        });
        $('pre#map').text(s);

        let canvas = $('#main');
        let ctx = $(canvas)[0].getContext('2d');
        m.forEach((row, rowIndex) => {
          row.forEach((col, colIndex) => {
            let tileRow = 1;
            let tileCol = 13;
            if (col == 1) {
              tileRow = 1;
              tileCol = 12;
            }
            if (col > 1) {
              tileRow = 10;
              tileCol = 7;
            }
            ctx.drawImage(tilesetImage, (tileCol * tileSize), (tileRow * tileSize), tileSize, tileSize, (colIndex * tileSize), (rowIndex * tileSize), tileSize, tileSize); 
          })
        }); 
      }

      socket.on('update', async (updateString) => {
        update = JSON.parse(atob(updateString));
        console.log(update);
        nonce = update.nonce;
        console.log('Update');
        if (!tilesetImage.complete) {
          await (() => new Promise(resolve => {
            setTimeout(resolve, 1000);
          }))();
        }
        render(tileMap, update.positions);
      });

      socket.on('init', async (mapString) => {
        tileMap = JSON.parse(atob(mapString));
        console.log(tileMap);

        const loadImage = (src) => {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
          });
        };

        tilesetImage = await loadImage('http://localhost:8000/' + tileMap.tileset);
        let canvas = $('#main');
        canvas.width = tileSize * tileMap.cols;
        canvas.height =  tileSize * tileMap.rows;

        render(tileMap, users);
      });

      socket.on('ack', (ack) => {
        console.log('ack? ' + ack);
        if (!ack) {
          nonce += 1;
        }
      });

      $('button').click((e) => {
        console.log('Move: ' + $(e.target).attr('id'));
        socket.emit('move', JSON.stringify({ direction: $(e.target).attr('id'), nonce: nonce+1 }));
      });
    </script>
  </body>
</html>