<!doctype html>
<html>
  <head>
    <title>Webassembly</title>
  </head>
  <style>
    .table {
      width: 30%;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
    }
  </style>
  <body>
    <h1>Webassembly</h1>
    <div class='table'>
      <div>&nbsp;</div>
      <div><button id='up'>UP</button></div>
      <div>&nbsp;</div>
      <div><button id='left'>LEFT</button></div>
      <div>&nbsp;</div>
      <div><button id='right'>RIGHT</button></div>
      <div>&nbsp;</div>
      <div><button id='down'>DOWN</button></div>
      <div>&nbsp;</div>
    </div>
    
    <pre id='map'></pre>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      var socket = io();
      let map = []
      let users = {};

      const render = (map, users) => {
        m = JSON.parse(JSON.stringify(map));
        Object.entries(users).forEach(([k, v]) => {
          m[v.y][v.x] = k;
        });
        let s = '';
        m.forEach(row => {
          s += row.join(' ') + '\n';
        });
        $('pre#map').text(s);
      }

      socket.on('positions', (usersString) => {
        users = JSON.parse(atob(usersString));
        console.log(users);

        render(map, users);
      });

      socket.on('init', (mapString) => {
        map = JSON.parse(atob(mapString));
        console.log(map);

        render(map, users);
      });

      socket.on('ack', (msg) => {
        console.log(msg);
      });

      $('button').click((e) => {
        console.log('Move: ' + $(e.target).attr('id'));
        socket.emit('move', $(e.target).attr('id'));
      });
    </script>
  </body>
</html>